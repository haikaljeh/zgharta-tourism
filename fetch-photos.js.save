eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ob2hwc2VlZ2ZuZnp5Y3h2Y3VrIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODQxNzA1MSwiZXhwIjoyMDgzOTkzMDUxfQ.pv0Ic0bvyCpt0np5Orm711n15TS54V1dzpNBE_J-7yU#!/usr/bin/env node
// =============================================
// PHOTO FETCHER - Google Places API â†’ Supabase
// =============================================
// This script:
// 1. Reads all places & businesses from Supabase
// 2. Searches Google Places API for each one
// 3. Gets the best photo URL
// 4. Updates the image_url in Supabase
//
// USAGE:
//   npm install @supabase/supabase-js node-fetch
//   node fetch-photos.js
//
// REQUIRES:
//   - Google Places API key (with Places API enabled)
//   - Supabase service role key (for write access)
// =============================================

const { createClient } = require('@supabase/supabase-js');

// ---- CONFIGURATION ----
// Replace these with your actual keys
const SUPABASE_URL = 'https://mhohpseegfnfzycxvcuk.supabase.co';
const SUPABASE_SERVICE_KEY = '$TS54V1dzpNBE_J-7yU#!/usr/bin/env node
// =============================================
// PHOTO FETCHER - Google Places API â†’ Supabase
// =============================================
// This script:
// 1. Reads all places & businesses from Supabase
// 2. Searches Google Places API for each one
// 3. Gets the best photo URL
// 4. Updates the image_url in Supabase
//
// USAGE:
//   npm install @supabase/supabase-js node-fetch
//   node fetch-photos.js
//
// REQUIRES:
//   - Google Places API key (with Places API enabled)
//   - Supabase service role key (for write access)
// =============================================

const { createClient } = require('@supabase/supabase-js');

// ---- CONFIGURATION ----
// Replace these with your actual keys
const SUPABASE_URL = 'https://mhohpseegfnfzycxvcuk.supabase.co';
const SUPABASE_SERVICE_KEY = 'YOUR_SUPABASE_SERVICE_ROLE_KEY'; // âš ï¸ Use SERVICE ROLE key, not anon key
const GOOGLE_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

// Google Places API base URLs

^G Get Help      ^O WriteOut      ^R Read File     ^Y Prev Pg       ^K Cut Text      ^C Cur Pos    '; // âš ï¸ Use SERVICE ROLE key, not anon key
const GOOGLE_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY';

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY);

// Google Places API base URLs
const PLACES_SEARCH_URL = 'https://maps.googleapis.com/maps/api/place/findplacefromtext/json';
const PLACES_DETAILS_URL = 'https://maps.googleapis.com/maps/api/place/details/json';
const PLACES_PHOTO_URL = 'https://maps.googleapis.com/maps/api/place/photo';

// Delay between API calls to avoid rate limits
const DELAY_MS = 500;
const sleep = ms => new Promise(r => setTimeout(r, ms));

async function searchPlace(name, village) {
  const query = `${name} ${village} Lebanon`;
  const url = `${PLACES_SEARCH_URL}?input=${encodeURIComponent(query)}&inputtype=textquery&fields=place_id,name,photos&key=${GOOGLE_API_KEY}`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.candidates && data.candidates.length > 0) {
      return data.candidates[0];
    }
    return null;
  } catch (err) {
    console.error(`  âŒ Search failed for "${name}": ${err.message}`);
    return null;
  }
}

async function getPlaceDetails(placeId) {
  const url = `${PLACES_DETAILS_URL}?place_id=${placeId}&fields=photos&key=${GOOGLE_API_KEY}`;
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    if (data.result?.photos && data.result.photos.length > 0) {
      return data.result.photos[0].photo_reference;
    }
    return null;
  } catch (err) {
    console.error(`  âŒ Details failed: ${err.message}`);
    return null;
  }
}

function getPhotoUrl(photoReference, maxWidth = 800) {
  // This URL will redirect to the actual photo
  return `${PLACES_PHOTO_URL}?maxwidth=${maxWidth}&photo_reference=${photoReference}&key=${GOOGLE_API_KEY}`;
}

async function processTable(tableName, items) {
  console.log(`\nðŸ“¸ Processing ${tableName} (${items.length} items)...`);
  console.log('â”€'.repeat(50));
  
  let updated = 0;
  let skipped = 0;
  let failed = 0;

  for (const item of items) {
    // Skip if already has an image
    if (item.image_url) {
      console.log(`  â­  ${item.name} â€” already has image`);
      skipped++;
      continue;
    }

    console.log(`  ðŸ” Searching: ${item.name} (${item.village})...`);
    await sleep(DELAY_MS);

    // Step 1: Search for the place
    const candidate = await searchPlace(item.name, item.village);
    if (!candidate) {
      console.log(`  âš ï¸  No results for "${item.name}"`);
      failed++;
      continue;
    }

    // Step 2: Get photo reference
    let photoRef = null;
    if (candidate.photos && candidate.photos.length > 0) {
      photoRef = candidate.photos[0].photo_reference;
    } else {
      // Try getting details for photos
      await sleep(DELAY_MS);
      photoRef = await getPlaceDetails(candidate.place_id);
    }

    if (!photoRef) {
      console.log(`  âš ï¸  No photos found for "${item.name}"`);
      failed++;
      continue;
    }

    // Step 3: Build photo URL
    const photoUrl = getPhotoUrl(photoRef, 800);

    // Step 4: Update Supabase
    const { error } = await supabase
      .from(tableName)
      .update({ image_url: photoUrl })
      .eq('id', item.id);

    if (error) {
      console.log(`  âŒ DB update failed for "${item.name}": ${error.message}`);
      failed++;
    } else {
      console.log(`  âœ… ${item.name} â€” photo saved!`);
      updated++;
    }

    await sleep(DELAY_MS);
  }

  console.log(`\n  ðŸ“Š ${tableName} results: ${updated} updated, ${skipped} skipped, ${failed} failed`);
  return { updated, skipped, failed };
}

async function main() {
  console.log('ðŸ‡±ðŸ‡§ Zgharta Tourism App â€” Photo Fetcher');
  console.log('=========================================\n');

  // Validate keys
  if (SUPABASE_SERVICE_KEY === 'YOUR_SUPABASE_SERVICE_ROLE_KEY') {
    console.error('âŒ Please set your SUPABASE_SERVICE_KEY in the script.');
    console.error('   Find it in: Supabase Dashboard â†’ Settings â†’ API â†’ service_role key');
    process.exit(1);
  }
  if (GOOGLE_API_KEY === 'YOUR_GOOGLE_MAPS_API_KEY') {
    console.error('âŒ Please set your GOOGLE_API_KEY in the script.');
    console.error('   Make sure Places API is enabled in Google Cloud Console.');
    process.exit(1);
  }

  // Fetch all places
  const { data: places, error: pErr } = await supabase.from('places').select('*');
  if (pErr) { console.error('âŒ Failed to fetch places:', pErr.message); process.exit(1); }

  // Fetch all businesses
  const { data: businesses, error: bErr } = await supabase.from('businesses').select('*');
  if (bErr) { console.error('âŒ Failed to fetch businesses:', bErr.message); process.exit(1); }

  console.log(`Found ${places.length} places and ${businesses.length} businesses\n`);

  // Process both tables
  const placesResult = await processTable('places', places);
  const bizResult = await processTable('businesses', businesses);

  // Summary
  const total = placesResult.updated + bizResult.updated;
  const totalFailed = placesResult.failed + bizResult.failed;
  console.log('\n=========================================');
  console.log(`ðŸŽ‰ Done! ${total} photos added, ${totalFailed} failed.`);
  console.log('=========================================');
  
  if (totalFailed > 0) {
    console.log('\nðŸ’¡ Tip: For failed items, you can manually add image URLs');
    console.log('   in the Supabase Table Editor â†’ image_url column');
  }

  console.log('\nâš ï¸  Note: Google Places photo URLs expire after a few months.');
  console.log('   For production, consider downloading images to Supabase Storage.');
  console.log('   Run this script periodically to refresh URLs.\n');
}

main().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
